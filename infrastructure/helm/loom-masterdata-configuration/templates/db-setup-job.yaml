apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "loom-masterdata-configuration.fullname" . }}-db-setup
  labels:
    {{- include "loom-masterdata-configuration.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "loom-masterdata-configuration.labels" . | nindent 8 }}
    spec:
      restartPolicy: OnFailure
      containers:
        - name: db-setup
          image: postgres:15-alpine
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              
              echo "Creating database..."
              psql -tc "SELECT 1 FROM pg_database WHERE datname = '$DBNAME'" | grep -q 1 || \
                psql -c "CREATE DATABASE $DBNAME"
              
              echo "Creating service user..."
              psql -tc "SELECT 1 FROM pg_roles WHERE rolname = '$DBUSER'" | grep -q 1 || \
                psql -c "CREATE USER $DBUSER WITH PASSWORD '$DBPASSWORD'"
              
              echo "Granting privileges..."
              psql -c "GRANT ALL PRIVILEGES ON DATABASE $DBNAME TO $DBUSER"
              psql -d "$DBNAME" -c "GRANT ALL ON SCHEMA public TO $DBUSER"
              psql -d "$DBNAME" -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO $DBUSER"
              psql -d "$DBNAME" -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO $DBUSER"
              
              echo "Database setup complete"
          env:
            - name: PGHOST
              value: {{ include "loom-masterdata-configuration.dbHost" . | quote }}
            - name: PGPORT
              value: {{ .Values.database.port | quote }}
            - name: PGUSER
              value: {{ .Values.database.adminUser | quote }}
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "loom-masterdata-configuration.adminSecretName" . }}
                  key: {{ include "loom-masterdata-configuration.adminSecretKey" . }}
            - name: DBNAME
              value: {{ .Values.database.name | quote }}
            - name: DBUSER
              value: {{ .Values.database.serviceUser | quote }}
            - name: DBPASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "loom-masterdata-configuration.serviceSecretName" . }}
                  key: {{ include "loom-masterdata-configuration.serviceSecretPasswordKey" . }}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]


